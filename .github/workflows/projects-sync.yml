name: Sync Projects

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch GitHub repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import re
          import urllib.request
          from pathlib import Path

          token = os.environ.get("GITHUB_TOKEN")
          api_base = "https://api.github.com"
          repos_url = f"{api_base}/users/alexzander73/repos?per_page=100&type=public&sort=pushed"
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
              "User-Agent": "projects-sync"
          }

          def request_json(url, accept=None):
              h = dict(headers)
              if accept:
                  h["Accept"] = accept
              req = urllib.request.Request(url, headers=h)
              with urllib.request.urlopen(req) as resp:
                  return json.load(resp)

          def request_text(url, accept=None):
              h = dict(headers)
              if accept:
                  h["Accept"] = accept
              req = urllib.request.Request(url, headers=h)
              with urllib.request.urlopen(req) as resp:
                  return resp.read().decode("utf-8", errors="ignore")

          def extract_description(markdown):
              if not markdown:
                  return ""
              lines = markdown.splitlines()
              in_code = False
              paragraph = []
              for line in lines:
                  if line.strip().startswith("```"):
                      in_code = not in_code
                      continue
                  if in_code:
                      continue
                  if line.strip().startswith("#"):
                      if paragraph:
                          break
                      continue
                  if not line.strip():
                      if paragraph:
                          break
                      continue
                  paragraph.append(line.strip())
              text = " ".join(paragraph)
              text = re.sub(r"\\s+", " ", text).strip()
              if len(text) > 160:
                  text = text[:157].rstrip() + "..."
              return text

          overrides_path = Path("data/projects.overrides.json")
          overrides = {}
          if overrides_path.exists():
              overrides = json.loads(overrides_path.read_text() or "{}")

          data = request_json(repos_url)

          items = []
          for repo in data:
              if repo.get("fork") or repo.get("archived"):
                  continue
              name = repo.get("name")
              description = repo.get("description") or ""
              if not description:
                  readme_url = f"{api_base}/repos/alexzander73/{name}/readme"
                  try:
                      markdown = request_text(readme_url, accept="application/vnd.github.raw")
                      description = extract_description(markdown)
                  except Exception:
                      description = ""

              item = {
                  "name": name,
                  "html_url": repo.get("html_url"),
                  "description": description or "",
                  "homepage": repo.get("homepage"),
                  "language": repo.get("language"),
                  "stargazers_count": repo.get("stargazers_count"),
                  "pushed_at": repo.get("pushed_at"),
                  "topics": repo.get("topics", []),
                  "open_issues_count": repo.get("open_issues_count"),
              }

              if name in overrides:
                  item.update(overrides[name])

              items.append(item)

          items.sort(key=lambda r: r.get("pushed_at") or "", reverse=True)
          Path("data/projects.auto.json").write_text(json.dumps(items, indent=2))
          PY

      - name: Commit changes
        run: |
          if git status --porcelain data/projects.auto.json | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/projects.auto.json
            git commit -m "Update projects.auto.json"
            git push
          else
            echo "No changes to commit"
          fi
