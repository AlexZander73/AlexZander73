name: Sync Projects

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch GitHub repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import urllib.request
          from pathlib import Path

          token = os.environ.get("GITHUB_TOKEN")
          url = "https://api.github.com/users/alexzander73/repos?per_page=100&type=public&sort=pushed"
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
              "User-Agent": "projects-sync"
          }

          req = urllib.request.Request(url, headers=headers)
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)

          items = []
          for repo in data:
              if repo.get("fork") or repo.get("archived"):
                  continue
              items.append({
                  "name": repo.get("name"),
                  "html_url": repo.get("html_url"),
                  "description": repo.get("description"),
                  "homepage": repo.get("homepage"),
                  "language": repo.get("language"),
                  "stargazers_count": repo.get("stargazers_count"),
                  "pushed_at": repo.get("pushed_at"),
                  "topics": repo.get("topics", []),
                  "open_issues_count": repo.get("open_issues_count"),
              })

          items.sort(key=lambda r: r.get("pushed_at") or "", reverse=True)
          Path("data/projects.auto.json").write_text(json.dumps(items, indent=2))
          PY

      - name: Commit changes
        run: |
          if git status --porcelain data/projects.auto.json | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/projects.auto.json
            git commit -m "Update projects.auto.json"
            git push
          else
            echo "No changes to commit"
          fi
